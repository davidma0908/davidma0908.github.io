<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨åŠŸèƒ½é‡åŒ–å›æ¸¬ç³»çµ± v11 (æ•¸æ“šæŸ¥æ ¸ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #1e293b; border-left: 4px solid #3b82f6; }
        .sidebar-item { border-left: 4px solid transparent; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .text-win { color: #10b981; } 
        .text-loss { color: #ef4444; } 
        .bg-win { background-color: #10b981; }
        .bg-loss { background-color: #ef4444; }
        /* è¡¨æ ¼å„ªåŒ– */
        td { vertical-align: middle; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shrink-0 z-20 shadow-xl">
        <div class="p-6 border-b border-slate-800">
             <h1 class="text-xl font-bold text-white tracking-wider">TRADER PRO</h1>
             <p class="text-xs text-slate-500 mt-1 uppercase">Audit & Debug v11</p>
        </div>
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item active flex items-center p-3 transition-all text-sm font-medium hover:text-white rounded-r-lg">
                <span class="mr-3">ğŸ“Š</span> ç¸½è¦½èˆ‡è©³ç´°æŒ‡æ¨™
            </a>
            <a href="#" onclick="switchTab('monthly')" id="nav-monthly" class="sidebar-item flex items-center p-3 transition-all text-sm font-medium hover:text-white rounded-r-lg">
                <span class="mr-3">ğŸ“…</span> æœˆåº¦ Kinfo åˆ†æ (æŸ¥æ ¸)
            </a>
            <a href="#" onclick="switchTab('charts')" id="nav-charts" class="sidebar-item flex items-center p-3 transition-all text-sm font-medium hover:text-white rounded-r-lg">
                <span class="mr-3">ğŸ“ˆ</span> è³‡é‡‘æ›²ç·šèˆ‡æŒå€‰
            </a>
            <a href="#" onclick="switchTab('price')" id="nav-price" class="sidebar-item flex items-center p-3 transition-all text-sm font-medium hover:text-white rounded-r-lg">
                <span class="mr-3">ğŸ’°</span> åƒ¹æ ¼å€é–“åˆ†æ
            </a>
            
            <div class="pt-6 mt-6 border-t border-slate-800">
                <label for="file-input" class="cursor-pointer flex items-center justify-center p-3 rounded-lg bg-blue-600 text-white hover:bg-blue-500 transition-colors shadow-lg font-bold">
                    åŒ¯å…¥ Excel / CSV
                </label>
                <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls, .csv, .txt">
            </div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <div class="flex-1 overflow-auto p-6 scroll-smooth" id="main-scroll-area">
            
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-400">
                <div class="w-24 h-24 bg-slate-200 rounded-full flex items-center justify-center mb-6 text-5xl shadow-inner">ğŸ“‚</div>
                <h2 class="text-2xl font-bold text-slate-600">æº–å‚™é–‹å§‹åˆ†æ</h2>
                <p class="mt-2 text-slate-500">è«‹å¾å·¦ä¸‹è§’åŒ¯å…¥æ‚¨çš„äº¤æ˜“ç´€éŒ„æª”æ¡ˆ</p>
            </div>

            <div id="section-dashboard" class="hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="card p-5 border-l-4 border-blue-500">
                        <p class="text-xs text-slate-400 uppercase font-bold">ç¸½äº¤æ˜“æ¬¡æ•¸</p>
                        <p id="stat-total-trades" class="text-2xl font-bold mt-1 text-slate-800">-</p>
                    </div>
                    <div class="card p-5 border-l-4 border-emerald-500">
                        <p class="text-xs text-slate-400 uppercase font-bold">å‹ç‡ (Win Rate)</p>
                        <p id="stat-win-rate" class="text-2xl font-bold mt-1 text-slate-800">-</p>
                    </div>
                     <div class="card p-5 border-l-4 border-indigo-500">
                        <p class="text-xs text-slate-400 uppercase font-bold">ç²åˆ©å› å­ (PF)</p>
                        <p id="stat-pf" class="text-2xl font-bold mt-1 text-indigo-600">-</p>
                    </div>
                     <div class="card p-5 border-l-4 border-purple-500">
                        <p class="text-xs text-slate-400 uppercase font-bold">R å€æ•¸æœŸæœ›å€¼</p>
                        <p id="stat-expectancy" class="text-2xl font-bold mt-1 text-slate-800">-</p>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-lg font-bold text-slate-800 mb-6 border-b pb-4 flex items-center">
                        <span class="mr-2">ğŸ“</span> è©³ç´°ç¸¾æ•ˆå ±å‘Š
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-6 text-sm">
                        <div class="space-y-4">
                            <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">äº¤æ˜“åˆ†ä½ˆ (æœ€é•·/æœ€çŸ­æœˆ)</span>
                                <span class="font-mono font-medium" id="detail-trades">-</span>
                            </div>
                            <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">å‹ç‡æ³¢å‹• (æœ€é«˜/æœ€ä½æœˆ)</span>
                                <span class="font-mono font-medium" id="detail-winrate-range">-</span>
                            </div>
                            <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">å¹³å‡ R å¢ç›Š (Avg Win)</span>
                                <span class="font-mono font-medium" id="detail-r-gain">-</span>
                            </div>
                            <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">å¹³å‡ R æå¤± (Avg Loss)</span>
                                <span class="font-mono font-medium" id="detail-r-loss">-</span>
                            </div>
                            <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">ç›ˆè™§æ¯” (Reward/Risk)</span>
                                <span class="font-mono font-medium" id="detail-r-ratio">-</span>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">é€£çºŒç²åˆ©/è™§ææœˆä»½</span>
                                <span class="font-mono font-medium" id="detail-month-streaks">-</span>
                            </div>
                             <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">ç²åˆ©æœ€é«˜æœˆä»½</span>
                                <span class="font-mono font-medium text-win" id="detail-best-month">-</span>
                            </div>
                             <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">è™§ææœ€å¤§æœˆä»½</span>
                                <span class="font-mono font-medium text-loss" id="detail-worst-month">-</span>
                            </div>
                             <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">å¹³å‡æŒå€‰ (ç²åˆ©å–®)</span>
                                <span class="font-mono font-medium" id="detail-hold-win">-</span>
                            </div>
                            <div class="flex justify-between border-b border-dashed pb-2">
                                <span class="text-slate-500">å¹³å‡æŒå€‰ (è™§æå–®)</span>
                                <span class="font-mono font-medium" id="detail-hold-loss">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-monthly" class="hidden flex flex-col h-full space-y-4" style="max-height: calc(100vh - 80px);">
                
                <div class="grid grid-cols-12 gap-6 flex-1 min-h-0">
                    <div class="col-span-4 card flex flex-col overflow-hidden h-full">
                        <div class="p-4 border-b bg-slate-50 font-bold text-slate-700">ğŸ“… æœˆåº¦ç¸½è¦½</div>
                        <div class="overflow-y-auto flex-1 p-2">
                            <table class="w-full text-sm text-left">
                                <tbody id="monthly-list-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="col-span-8 flex flex-col gap-4 h-full">
                        
                        <div class="card flex flex-col h-1/2 overflow-hidden relative">
                            <div id="month-detail-header" class="p-4 border-b bg-white flex justify-between items-center z-10 hidden">
                                <div>
                                    <h3 id="detail-title" class="text-lg font-bold text-slate-800"></h3>
                                    <p class="text-xs text-slate-500">é»æ“Šé•·æ¢åœ–å¯æŸ¥çœ‹ Fugle AI åˆ†æ</p>
                                </div>
                                <div class="text-right">
                                    <p id="detail-month-pl" class="text-lg font-bold font-mono">0</p>
                                    <p id="detail-month-stats" class="text-xs text-slate-400">0 ç­†äº¤æ˜“</p>
                                </div>
                            </div>
                            <div class="flex-1 p-4 relative bg-slate-50 flex items-center justify-center">
                                <div id="chart-placeholder" class="text-center text-slate-400">
                                    <p class="text-lg">ğŸ‘ˆ è«‹é»æ“Šå·¦å´æœˆä»½æŸ¥çœ‹åˆ†æ</p>
                                </div>
                                <canvas id="kinfo-chart" class="hidden max-h-full w-full"></canvas>
                            </div>
                        </div>

                        <div id="audit-table-container" class="card flex flex-col h-1/2 overflow-hidden hidden">
                            <div class="p-3 border-b bg-yellow-50 text-yellow-800 text-sm font-bold flex justify-between">
                                <span>ğŸ” äº¤æ˜“æ˜ç´°æŸ¥æ ¸ (æ ¸å°é‡‘é¡ç”¨)</span>
                                <span class="text-xs font-normal">è«‹æª¢æŸ¥æ˜¯å¦æœ‰ç•°å¸¸äº¤æ˜“æˆ–é‡è¤‡è¨ˆç®—</span>
                            </div>
                            <div class="overflow-y-auto flex-1 p-0">
                                <table class="w-full text-xs text-left">
                                    <thead class="bg-slate-50 sticky top-0 border-b">
                                        <tr>
                                            <th class="p-3">æ—¥æœŸ</th>
                                            <th class="p-3">ä»£è™Ÿ</th>
                                            <th class="p-3">åç¨±</th>
                                            <th class="p-3 text-right">æç›Š</th>
                                            <th class="p-3 text-right">åƒ¹æ ¼</th>
                                        </tr>
                                    </thead>
                                    <tbody id="audit-list-body" class="divide-y divide-slate-100">
                                        </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div id="section-charts" class="hidden space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">è³‡é‡‘æ¬Šç›Šæ›²ç·š (Equity Curve)</h3>
                    <div class="h-80"><canvas id="chart-equity"></canvas></div>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">æŒå€‰å¤©æ•¸ vs æç›Šåˆ†ä½ˆ</h3>
                    <div class="h-80"><canvas id="chart-scatter"></canvas></div>
                </div>
            </div>

            <div id="section-price" class="hidden space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">è‚¡åƒ¹å€é–“ç¸¾æ•ˆ</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="h-80"><canvas id="chart-price-bar"></canvas></div>
                        <div id="table-price-container" class="overflow-y-auto h-80"></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸ ---
        const MAPPING = {
            profit: ['æç›Š', 'Profit', 'GainLoss', 'å·²å¯¦ç¾æç›Š', 'å¯¦ç²æç›Š', 'é ä¼°æç›Š'],
            date: ['è³£å‡ºæ—¥æœŸ', 'ExitDate', 'SellDate', 'äº¤å‰²æ—¥æœŸ', 'æ—¥æœŸ'],
            entryDate: ['è²·é€²æ—¥æœŸ', 'EntryDate', 'BuyDate', 'é€²å ´æ—¥æœŸ', 'æˆäº¤æ—¥æœŸ'],
            code: ['è‚¡ç¥¨ä»£è™Ÿ', 'Code', 'Symbol', 'StockID', 'å•†å“ä»£ç¢¼', 'ä»£è™Ÿ'],
            name: ['è‚¡ç¥¨åç¨±', 'Name', 'å•†å“', 'StockName', 'åç¨±'],
            price: ['è²·é€²åƒ¹æ ¼', 'EntryPrice', 'BuyPrice', 'æˆäº¤å–®åƒ¹', 'å–®åƒ¹', 'æˆæœ¬']
        };

        let TRADES = [];
        let MONTHLY_STATS = {};
        let RISK_UNIT = 1; 
        let CHARTS = {};

        // --- æª”æ¡ˆè™•ç† ---
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                parseData(json);
            };
            reader.readAsArrayBuffer(file);
        });

        // æ•¸å­—æ¸…æ´—ï¼šè™•ç† (1,234.5) é€™ç¨®æœƒè¨ˆæ ¼å¼
        function cleanNumber(val) {
            if (typeof val === 'number') return val;
            let str = String(val).trim();
            // æª¢æŸ¥æ˜¯å¦ç‚º (123) æ ¼å¼
            const isNegative = str.startsWith('(') && str.endsWith(')');
            // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦ (ä¿ç•™å°æ•¸é»èˆ‡è² è™Ÿ)
            str = str.replace(/[^\d.-]/g, '');
            let num = parseFloat(str);
            if (isNaN(num)) return 0;
            return isNegative ? -num : num;
        }

        function parseData(rows) {
            let headerIdx = -1;
            let map = {};
            
            // å°‹æ‰¾æ¨™é¡Œåˆ—
            for(let i=0; i<Math.min(rows.length, 30); i++) {
                const rowStr = rows[i].map(c => String(c).trim());
                let found = {};
                for(let key in MAPPING) {
                    let idx = rowStr.findIndex(cell => MAPPING[key].some(k => cell.includes(k)));
                    if(idx > -1) found[key] = idx;
                }
                if(found.profit !== undefined) {
                    headerIdx = i;
                    map = found;
                    break;
                }
            }

            if(headerIdx === -1) { alert("æ‰¾ä¸åˆ°é—œéµæ¬„ä½ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼"); return; }

            TRADES = [];
            for(let i=headerIdx+1; i<rows.length; i++) {
                const row = rows[i];
                
                // åš´æ ¼æ—¥æœŸæª¢æŸ¥ï¼šæ²’æœ‰æ—¥æœŸå°±è·³éï¼ˆé¿å…è®€åˆ° Excel çš„ç¸½è¨ˆè¡Œï¼‰
                let d = parseDate(row[map.date]);
                if (!d) continue; 

                // æ•¸å­—è™•ç†
                let p = cleanNumber(row[map.profit]);
                
                let ed = parseDate(row[map.entryDate]);
                if(!ed) ed = d; 

                let codeVal = row[map.code];
                let nameVal = row[map.name];
                let displayCode = codeVal ? String(codeVal).trim() : (nameVal ? String(nameVal).trim() : 'Unknown');
                let priceVal = cleanNumber(row[map.price]);

                TRADES.push({
                    profit: p,
                    date: d,
                    entryDate: ed,
                    code: displayCode,
                    name: nameVal || '',
                    price: priceVal,
                    holdDays: Math.max(1, (d - ed) / (1000 * 60 * 60 * 24))
                });
            }
            
            TRADES.sort((a,b) => a.date - b.date);
            calculateMetrics();
            
            renderDashboard();
            renderCharts();
            renderPriceAnalysis();
            renderMonthlyList();
            
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('section-dashboard').classList.remove('hidden');
            document.querySelector('.sidebar-item.active').classList.remove('active');
            document.getElementById('nav-dashboard').classList.add('active');
        }

        function parseDate(val) {
            if(!val) return null;
            if(val instanceof Date) return val;
            let s = String(val).trim();
            if(s.length === 8 && !isNaN(s)) return new Date(`${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`);
            if(s.includes('/')) {
                let parts = s.split('/');
                if(parts[0].length === 3) return new Date(`${parseInt(parts[0])+1911}-${parts[1]}-${parts[2]}`);
            }
            // å˜—è©¦æ¨™æº–è§£æï¼Œè‹¥ç„¡æ•ˆå›å‚³ null
            let d = new Date(s);
            return isNaN(d.getTime()) ? null : d;
        }

        function calculateMetrics() {
            const losses = TRADES.filter(t => t.profit < 0);
            const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((a,b)=>a+b.profit,0) / losses.length) : 1;
            RISK_UNIT = avgLoss === 0 ? 1 : avgLoss;

            TRADES.forEach(t => t.r = t.profit / RISK_UNIT);

            MONTHLY_STATS = {};
            TRADES.forEach(t => {
                const ym = t.date.toISOString().slice(0, 7);
                if(!MONTHLY_STATS[ym]) {
                    MONTHLY_STATS[ym] = { 
                        profit: 0, count: 0, wins: 0, trades: [], 
                        rGainSum: 0, rLossSum: 0, 
                        holdWinSum: 0, holdLossSum: 0,
                        holdWinCount: 0, holdLossCount: 0
                    };
                }
                const m = MONTHLY_STATS[ym];
                m.profit += t.profit;
                m.count++;
                m.trades.push(t);
                
                if(t.profit > 0) {
                    m.wins++;
                    m.rGainSum += t.r;
                    m.holdWinSum += t.holdDays;
                    m.holdWinCount++;
                } else {
                    m.rLossSum += Math.abs(t.r);
                    m.holdLossSum += t.holdDays;
                    m.holdLossCount++;
                }
            });

            for(let ym in MONTHLY_STATS) {
                const m = MONTHLY_STATS[ym];
                m.winRate = m.count ? (m.wins / m.count) * 100 : 0;
                m.avgRGain = m.holdWinCount > 0 ? m.rGainSum / m.holdWinCount : 0;
                m.avgRLoss = m.holdLossCount > 0 ? m.rLossSum / m.holdLossCount : 0;
                m.avgHoldWin = m.holdWinCount > 0 ? m.holdWinSum / m.holdWinCount : 0;
                m.avgHoldLoss = m.holdLossCount > 0 ? m.holdLossSum / m.holdLossCount : 0;
            }
        }

        // --- æ¸²æŸ“å€å¡Š ---

        function renderDashboard() {
            // èˆ‡å‰ç‰ˆç›¸åŒ
            const totalProfit = TRADES.reduce((a,b)=>a+b.profit,0);
            const wins = TRADES.filter(t => t.profit > 0);
            const losses = TRADES.filter(t => t.profit <= 0);
            const winRate = (wins.length / TRADES.length * 100).toFixed(1);
            const grossWin = wins.reduce((a,b)=>a+b.profit,0);
            const grossLoss = Math.abs(losses.reduce((a,b)=>a+b.profit,0));
            const pf = grossLoss ? (grossWin/grossLoss).toFixed(2) : 'âˆ';
            const avgWinR = wins.length ? wins.reduce((a,b)=>a+b.r,0) / wins.length : 0;
            const avgLossR = losses.length ? Math.abs(losses.reduce((a,b)=>a+b.r,0)) / losses.length : 0;
            const expectancy = ((avgWinR * (wins.length/TRADES.length)) - (avgLossR * (losses.length/TRADES.length))).toFixed(2);

            setText('stat-total-trades', TRADES.length);
            setText('stat-win-rate', winRate + '%');
            setText('stat-pf', pf);
            setText('stat-expectancy', expectancy + 'R');

            const months = Object.keys(MONTHLY_STATS);
            const maxTradesM = getExtreme(months, m => m.count, true);
            const minTradesM = getExtreme(months, m => m.count, false);
            const maxWinM = getExtreme(months, m => m.winRate, true);
            const minWinM = getExtreme(months, m => m.winRate, false);
            const maxRGainM = getExtreme(months, m => m.avgRGain, true);
            const minRGainM = getExtreme(months, m => m.avgRGain, false);
            const maxRLossM = getExtreme(months, m => m.avgRLoss, true);
            const minRLossM = getExtreme(months, m => m.avgRLoss, false);
            const bestMonth = getExtreme(months, m => m.profit, true);
            const worstMonth = getExtreme(months, m => m.profit, false);
            const maxHoldWinM = getExtreme(months, m => m.avgHoldWin, true);
            const minHoldWinM = getExtreme(months, m => m.avgHoldWin, false);
            const maxHoldLossM = getExtreme(months, m => m.avgHoldLoss, true);
            const minHoldLossM = getExtreme(months, m => m.avgHoldLoss, false);

            const sortedMonths = months.sort();
            let maxWinS = 0, currWinS = 0;
            let maxLossS = 0, currLossS = 0;
            sortedMonths.forEach(ym => {
                if(MONTHLY_STATS[ym].profit > 0) {
                    currWinS++; maxWinS = Math.max(maxWinS, currWinS); currLossS = 0;
                } else {
                    currLossS++; maxLossS = Math.max(maxLossS, currLossS); currWinS = 0;
                }
            });

            const maxTradeWin = TRADES.reduce((max, t) => t.profit > max.profit ? t : max, TRADES[0]);
            const maxTradeLoss = TRADES.reduce((min, t) => t.profit < min.profit ? t : min, TRADES[0]);

            setText('detail-trades', `ç¸½è¨ˆ: ${TRADES.length} (æœ€é•·æœˆ: ${maxTradesM.val}, æœ€çŸ­æœˆ: ${minTradesM.val})`);
            setText('detail-winrate-range', `æœ€é«˜: ${maxWinM.val.toFixed(1)}% (${maxWinM.ym}), æœ€ä½: ${minWinM.val.toFixed(1)}% (${minWinM.ym})`);
            setText('detail-r-gain', `å¹³å‡: ${avgWinR.toFixed(1)}R (æœ€é«˜æœˆ: ${maxRGainM.val.toFixed(1)})`);
            setText('detail-r-loss', `å¹³å‡: ${avgLossR.toFixed(2)}R (æœ€é«˜æœˆ: ${maxRLossM.val.toFixed(2)})`);
            setText('detail-r-ratio', `å…¨åŸŸ: ${(avgWinR/avgLossR).toFixed(2)}`);
            setText('detail-month-streaks', `é€£å‹: ${maxWinS} å€‹æœˆ, é€£æ•—: ${maxLossS} å€‹æœˆ`);
            setText('detail-best-month', `${bestMonth.ym} (+$${formatK(bestMonth.val)})`);
            setText('detail-worst-month', `${worstMonth.ym} ($${formatK(worstMonth.val)})`);
            
            const avgHoldWin = wins.reduce((s,t)=>s+t.holdDays,0)/wins.length;
            const avgHoldLoss = losses.reduce((s,t)=>s+t.holdDays,0)/losses.length;
            setText('detail-hold-win', `${avgHoldWin.toFixed(1)} å¤© (æœ€é•·æœˆ: ${maxHoldWinM.val.toFixed(1)})`);
            setText('detail-hold-loss', `${avgHoldLoss.toFixed(1)} å¤© (æœ€é•·æœˆ: ${maxHoldLossM.val.toFixed(1)})`);

            setText('detail-max-win', `${maxTradeWin.date.toISOString().slice(0,10)} ${maxTradeWin.code}: ${maxTradeWin.r.toFixed(1)}R`);
            setText('detail-max-loss', `${maxTradeLoss.date.toISOString().slice(0,10)} ${maxTradeLoss.code}: ${maxTradeLoss.r.toFixed(1)}R`);
        }

        function renderCharts() {
            // Equity Curve
            let cum = 0;
            const equityData = TRADES.map(t => { cum += t.profit; return cum; });
            const ctxEq = document.getElementById('chart-equity').getContext('2d');
            if(CHARTS.equity) CHARTS.equity.destroy();
            CHARTS.equity = new Chart(ctxEq, {
                type: 'line',
                data: {
                    labels: TRADES.map((_, i) => i),
                    datasets: [{
                        label: 'æ¬Šç›Š',
                        data: equityData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
            });

            // Scatter
            const points = TRADES.map(t => ({ x: t.holdDays, y: t.profit }));
            const ctxSc = document.getElementById('chart-scatter').getContext('2d');
            if(CHARTS.scatter) CHARTS.scatter.destroy();
            CHARTS.scatter = new Chart(ctxSc, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'äº¤æ˜“',
                        data: points,
                        backgroundColor: points.map(p => p.y >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)')
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: {display:true, text:'æŒå€‰å¤©æ•¸'} } } }
            });
        }

        function renderPriceAnalysis() {
             const bins = [
                {min:0, max:20, label:'< $20'},
                {min:20, max:50, label:'$20 - $50'},
                {min:50, max:100, label:'$50 - $100'},
                {min:100, max:200, label:'$100 - $200'},
                {min:200, max:99999, label:'> $200'}
            ];
            bins.forEach(b => { b.p=0; b.c=0; b.w=0; });

            TRADES.forEach(t => {
                if(t.price <= 0.1) return;
                const b = bins.find(x => t.price >= x.min && t.price < x.max);
                if(b) { b.p += t.profit; b.c++; if(t.profit>0) b.w++; }
            });

            const labels = bins.map(b=>b.label);
            const data = bins.map(b=>b.p);
            const ctx = document.getElementById('chart-price-bar').getContext('2d');
            if(CHARTS.price) CHARTS.price.destroy();
            CHARTS.price = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç¸½æç›Š',
                        data: data,
                        backgroundColor: data.map(v => v>=0 ? '#10b981' : '#ef4444')
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            
            let html = `<table class="w-full text-sm text-center"><thead class="bg-slate-50 font-bold"><tr><th class="p-2">åƒ¹æ ¼</th><th>æ¬¡æ•¸</th><th>å‹ç‡</th><th>æç›Š</th></tr></thead><tbody>`;
            bins.forEach(b => {
                if(b.c === 0) return;
                html += `<tr class="border-b"><td class="p-2">${b.label}</td><td>${b.c}</td><td>${(b.w/b.c*100).toFixed(0)}%</td><td class="${b.p>=0?'text-win':'text-loss'}">${formatMoney(b.p)}</td></tr>`;
            });
            document.getElementById('table-price-container').innerHTML = html + '</tbody></table>';
        }

        function renderMonthlyList() {
            const tbody = document.getElementById('monthly-list-body');
            tbody.innerHTML = '';
            const sortedMonths = Object.keys(MONTHLY_STATS).sort().reverse();

            sortedMonths.forEach(ym => {
                const m = MONTHLY_STATS[ym];
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-blue-50 cursor-pointer transition-colors";
                tr.onclick = () => showKinfoChart(ym);
                
                const plClass = m.profit >= 0 ? 'text-win' : 'text-loss';
                
                tr.innerHTML = `
                    <td class="px-3 py-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-mono font-medium text-slate-700 text-lg">${ym}</span>
                            <span class="${plClass} font-bold text-right">${formatK(m.profit)}</span>
                        </div>
                        <div class="flex justify-between text-xs text-slate-400">
                            <span>${m.count} ç­†</span>
                            <span>å‹ç‡: ${m.winRate.toFixed(0)}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showKinfoChart(ym) {
            document.getElementById('chart-placeholder').classList.add('hidden');
            document.getElementById('kinfo-chart').classList.remove('hidden');
            document.getElementById('month-detail-header').classList.remove('hidden');
            document.getElementById('audit-table-container').classList.remove('hidden');

            const m = MONTHLY_STATS[ym];
            setText('detail-title', `${ym}`);
            setText('detail-month-pl', formatMoney(m.profit));
            document.getElementById('detail-month-pl').className = `text-lg font-bold font-mono ${m.profit>=0?'text-win':'text-loss'}`;
            setText('detail-month-stats', `${m.count} ç­†äº¤æ˜“, å‹ç‡ ${m.winRate.toFixed(0)}%`);

            const trades = [...m.trades].sort((a,b) => b.profit - a.profit); 
            
            // æ¸²æŸ“æŸ¥æ ¸è¡¨
            const auditBody = document.getElementById('audit-list-body');
            auditBody.innerHTML = '';
            trades.forEach(t => {
                const row = document.createElement('tr');
                const pClass = t.profit >= 0 ? 'text-win' : 'text-loss';
                row.innerHTML = `
                    <td class="p-3 font-mono text-slate-500">${t.date.toISOString().slice(0,10)}</td>
                    <td class="p-3 font-bold text-slate-700">${t.code}</td>
                    <td class="p-3 text-slate-600 truncate max-w-[100px]">${t.name}</td>
                    <td class="p-3 text-right font-mono font-bold ${pClass}">${formatMoney(t.profit)}</td>
                    <td class="p-3 text-right font-mono text-slate-400">${t.price}</td>
                `;
                auditBody.appendChild(row);
            });

            // æ¸²æŸ“åœ–è¡¨
            const labels = trades.map(t => t.code);
            const data = trades.map(t => t.profit);
            const rVals = trades.map(t => t.r.toFixed(2));
            const bg = data.map(v => v>=0 ? '#10b981' : '#ef4444');

            const ctx = document.getElementById('kinfo-chart').getContext('2d');
            if(CHARTS.kinfo) CHARTS.kinfo.destroy();
            
            CHARTS.kinfo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ data: data, backgroundColor: bg, borderRadius: 3 }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const stockId = labels[index];
                            if(stockId && stockId !== 'Unknown') {
                                window.open(`https://www.fugle.tw/ai/${stockId}`, '_blank');
                            }
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const idx = ctx.dataIndex;
                                    return `$${ctx.raw.toLocaleString()} (${rVals[idx]}R) (é»æ“ŠæŸ¥çœ‹ Fugle åˆ†æ)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: '#f1f5f9' } },
                        y: { 
                            ticks: { 
                                font: { weight: 'bold', family: 'Roboto Mono' },
                                color: '#334155' 
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // --- Helpers ---
        function switchTab(id) {
            document.querySelectorAll('main > div > div[id^="section-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`section-${id}`).classList.remove('hidden');
            document.getElementById(`nav-${id}`).classList.add('active');
            if(id === 'monthly' && CHARTS.kinfo) CHARTS.kinfo.resize();
        }

        function getExtreme(months, cb, isMax) {
            let extVal = isMax ? -Infinity : Infinity;
            let extYM = '-';
            months.forEach(ym => {
                const v = cb(MONTHLY_STATS[ym]);
                if(isMax) { if(v > extVal) { extVal = v; extYM = ym; } }
                else { if(v < extVal) { extVal = v; extYM = ym; } }
            });
            return { ym: extYM, val: extVal };
        }

        function setText(id, t) { const el = document.getElementById(id); if(el) el.innerText = t; }
        function formatMoney(n) { return (n<0?'-$':'$') + Math.abs(Math.round(n)).toLocaleString(); }
        function formatK(n) { if(Math.abs(n)>999) return (n/1000).toFixed(1)+'k'; return Math.round(n).toLocaleString(); }
    </script>
</body>
</html>